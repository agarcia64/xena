---
- targets:
    - node0
    - node1
  jobs:
   # enable ceph repos
   - RUN: >-
       --skip-cache --stdout-arg tripleo_repo_rpm
       curl -s https://trunk.rdoproject.org/centos8/component/tripleo/current/ | egrep -o '"python3-tripleo-repos.*rpm"' | tr -d "\""
   - RUN: --skip-cache dnf -y -q install https://trunk.rdoproject.org/centos8/component/tripleo/current/{{ tripleo_repo_rpm }}
   - RUN: --skip-cache tripleo-repos --stream -b master current-tripleo ceph
   - RUN: --skip-cache dnf -y -q clean all
   - RUN: --skip-cache dnf -y -q makecache
   # install cephadm
   - DNF: --latest cephadm

- targets:
    - node0
    - node1
  jobs:
   # create ceph-admin user
   - RUN: useradd ceph-admin
   - RUN: echo "ceph-admin ALL=(root) NOPASSWD:ALL" | tee -a /etc/sudoers.d/ceph-admin
     vars:
       chmod: "0440"
   - WORKDIR: /home/ceph-admin/.ssh
     vars:
       chown: "ceph-admin:ceph-admin"
       chmod: "0700"

- targets:
    - node0
  async: False
  jobs:
   # create ceph-admin ssh keys first node
   - RUN: ssh-keygen -t ed25519 -N "" -f /home/ceph-admin/.ssh/id_ed25519
     vars:
       chown: "ceph-admin:ceph-admin"
       chmod: "0600"
   - RUN: cp /home/ceph-admin/.ssh/id_ed25519.pub /home/ceph-admin/.ssh/authorized_keys
     vars:
       chown: "ceph-admin:ceph-admin"
       chmod: "0600"
   # I should not need to run chown, but I do
   - RUN: chown ceph-admin:ceph-admin /home/ceph-admin/.ssh/*
   - RUN: chcon system_u:object_r:ssh_home_t:s0 /home/ceph-admin/.ssh
   - RUN: chcon unconfined_u:object_r:ssh_home_t:s0 /home/ceph-admin/.ssh/authorized_keys

# - targets:
#     - node0
#     - node1
#   jobs:
#     - ADD: /home/ceph-admin/.ssh/* /home/ceph-admin/.ssh/
#     # AttributeError: The value of [ /home/ceph-admin/.ssh/* ] was not found. ??
    
